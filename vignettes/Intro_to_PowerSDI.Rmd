---
title: "Introduction to PowerSDI"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to PowerSDI}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(PowerSDI)
```

# Introduction

The 'PowerSDI' R-package calculates the Standardized Precipitation (SPI; Mckee et al., 1993) and Standardized Precipitation-Evapotranspiration (SPEI; Vicente-Serrano et al., 2010) indices using gridded-data from the NASA-POWER project. The package includes functions (ScientSDI.R, Reference.R, Accuracy.R and PlotData.R), which evaluate how well the drought indices meet their conceptual assumptions. The OperatSDI.R function allows users to download NASA-POWER data for specific monitoring periods. The package adopts a quasi-weekly basic time scale (quart.month), allowing for four index calculations per month: days 1 to 7, days 8 to 14, days 15 to 21, and days 22 to 28, 29, 30, or 31 depending on the month. For instance, if the time scale is set to 4 (TS=4), it corresponds to a moving window with a 1-month length that is calculated four times each month. If TS=48, the time scale corresponds to a moving window with a 12-month length that is calculated four times each month. The PowerSDI uses functions from the 'nasapower' (Sparks, 2018 and Sparks, 2023) and Lmom   (Hosking, 2022) packages.

# Installation

``` r
devtools::install_github("gabrielblain/PowerSDI")
```

# Basic Instructions: Getting Started

## Using PlotData() to visually inspect NASA-POWER data

The PlotData function allows a visual inspection of the indices' inputs (precipitation and potential evapotranspiration) obtained from the NASA-POWER project. These inputs (in millimeters) are show at the 1-quart.month time scale.

## Example 1: Inspecting indices' input for Campinas-SP, Brazil

```{r PlotData}
PlotData(lon = -47.3, lat = -22.65, start.date = "1991-01-01", end.date = "2022-12-31")
```

## ScientSDI(): Removing suspicious data and calculating the distributions's parameters

The first step of the SPI and SPEI algorithms is to calculate the cumulative probabilities of their input variables (Guttman, 1999).The ScientSDI function estimates the parameters of the gamma, generalized extreme value (GEV), or generalized logistic distributions (GLO) through the L-moments method. This function also allows users to remove suspicious values from the data sample.

## Example 2: Applying the ScientSDI function for Campinas-SP, Brazil

The plots generated by the PlotData.R function for Campinas revealed one suspicious rain value larger than 250 mm. Since this suspicious record represents less than 1% of the data sample, we removed it from the analyses before calculating the parameters of the gamma and GEV distributions. The PE data showed no suspicious values.

```{r ScientSDI (basic)}
Campinas=ScientSDI(lon = -47.3, lat = -22.65, start.date="1991-01-01", end.date="2022-12-31",distr = "GEV", TS=4, Good="no",RainUplim = 250,RainLowlim = NULL, PEUplim = NULL, PELowlim = NULL)
Campinas$SDI
Campinas$DistPar
```

## Accuracy(): Verifying how well NASA-POWER data actually represent real-world/observed data

A basic assumption related to remote sensing data is that they really represent the "real-world" conditions. Thus, the Accuracy function calculates the following measures of accuracy: the absolute mean error (AME), root-mean-square-error (RMSE), original (dorig), modified (dmod), refined (dref) Willmott's indices of agreement, and Pearson determination coefficient (R2).

## Example 3: Applying the Accuracy function to compare observed (obs) and NASA-POWER PE data in Campinas-SP, Brazil

In the example below, data("ObsEst") contains pairs of observed and estimated potential evapotranspiration (PE) data. The observed and estimated data were obtained from a weather station in Campinas and from the NASA-POWER project, respectively. PE was estimated using the Hargreaves & Samani method (Hargreaves and Samani, 1985).

```{r Accuracy (basic)}
 data("ObsEst")
 Compare_PE_Cps <- Accuracy(obs_est = ObsEst, conf.int = "No")
 Compare_PE_Cps
```

## OperatSDI(): Generating routine operational NASA-SPI and NASA-SPEI estimates

Considering that the parameters of the gamma (SPI) and GEV (SPEI) distributions have already been estimated by the ScientSDI function, we can now use the OperatSDI function to calculate these two indices on a routine basis.

## Example 4: Applying the OperatSDI function to calculate the SPI and SPEI in Campinas-SP, Brazil

The OperatSDI function enables users to download NASA-POWER data only for the period they intend to monitor.

```{r OperatSDI}
parms <- Campinas$DistPar # Obtained in Example 2
SDI=OperatSDI(lon = -47.3, lat = -22.65, start.date = "2023-08-01", end.date = "2023-08-07", parms = Campinas$DistPar, TS=4)
SDI
```

# Not so basic Instructions:

## The ScientSDI(): Removing suspicious data and assessing the indices' conceptual assumptions

As standardized indices, both SPI and SPEI are expected to provide spatially consistent interpretations of their values (Guttman, 1999). Therefore, their frequency distributions are expected to always approach the standard normal distribution regardless of the region, season, or time scale at which the indices are calculated (Wu et al., 2007, Stagge et al., 2015, Blain et al., 2018). In this context, the ScientSDI function calculates two normality-checking procedures described by Wu et al. (2007) and Stagge et al. (2015). Additionally, the calculation algorithm of the SPI and SPEI relies on fitting a parametric distribution to their input data. Therefore, the ScientSDI.R function also applies the widely-used Lilliefors (Lilliefors, 1967) and Anderson-Darling (Anderson and Darling, 1954) goodness-of-fit tests to the gamma and GEV/GLO distributions. The function ScientSDI.R allows users to select significance levels ranging from 5 to 10% to run these tests. Additionally, the SPEI algorithm often uses the generalized extreme value (GEV) or the generalized logistic (GLO) (Vicente-Serrano et al., 2010; Beguería et al., 2014; Stagge et al., 2015; Stagge et al., 2016; Vicente-Serrano and Beguería, 2016 and Blain et al., 2018). A review of these studies suggests that the performance of these two distributions for calculating the SPEI tends to be similar to each other over most of the range of the index possible values (e.g. -2.0:2:0). However, these studies also found significant differences between the two probability functions in the lower and upper tails (Vicente-Serrano and Beguería, 2016). In this context, the ScientSDI function also allows the users to choose between these two models when calculating the SPEI.

## Example 5.1: Applying the ScientSDI function with the GEV and verifying conceptual assumptions (Campinas-SP).

```{r ScientSDI (complete/GEV)}
Campinas.GEV=ScientSDI(lon = -47.3, lat = -22.65, start.date="1991-01-01", end.date="2022-12-31",distr = "GEV", TS=4, Good="yes",sig.level = 0.95, RainUplim = 250,RainLowlim = NULL, PEUplim = NULL, PELowlim = NULL)
Campinas.GEV$GoodFit
Campinas.GEV$Normality
```

## Example 5.2: Applying the ScientSDI function with the GLO and verifying conceptual assumptions (Campinas-SP).

```{r ScientSDI (complete/GLO)}
Campinas.GLO=ScientSDI(lon = -47.3, lat = -22.65, start.date="1991-01-01", end.date="2022-12-31",distr = "GLO", TS=4, Good="yes",sig.level = 0.95, RainUplim = 250,RainLowlim = NULL, PEUplim = NULL, PELowlim = NULL)
Campinas.GLO$GoodFit
Campinas.GLO$Normality
```

## The Accuracy(): Applying the Accuracy function and calculating confidence intervals.

The Accuracy function may also provide confidence intervals(CI) for AME, RMSE, dorig, dmod and dref. As emphasized by Willmott et al. (1985), the CI specifies a range of values within which these statistics are expected to vary by chance. Consequently, users can interpret the magnitude of the CI as an indicator of the reliability of the estimated values for the comparison metrics (Willmott et al., 1985). The function allows users to select between 90 and 95% CIs.

## Example 6: Applying the Accuracy function and calculating confidence intervals (Campinas-SP).

```{r Accuracy (complete)}
 data("ObsEst")
 Compare_PE_Cps_withCI <- Accuracy(obs_est = ObsEst, conf.int = "yes", sig.level = 0.95)
 Compare_PE_Cps_withCI
```
# References

Anderson, T.W., and Darling, D. A., 1954. A Test of Goodness of Fit. Journal of the American Statistical Association, 49:268, 765-769.  https://doi.org/10.2307/2281537

Beguería S., Vicente-Serrano S. M., Reig F., Latorre B., 2014. Standardized precipitation evapotranspiration index (SPEI) revisited: parameter fitting, evapotranspiration models, tools, datasets and drought monitoring. International Journal of Climatology, 34(10): 3001–3023. https://doi.org/10.1002/joc.3887

Blain, G. C., De Avila, A. M. H. and Pereira, V. R., 2018. Using the normality assumption to calculate probability based standardized drought indices: selection criteria with emphases on typical events. International Journal of Climatology, 38(S1), e418–e436. https://doi.org/10.1002/joc.5381

Guttman, N. B., 1999. Accepting the Standardized Precipitation Index: a calculation algorithm. Journal of the American Water Resources Association, 35, 311–322. https://doi.org/10.1111/j.1752-1688.1999.tb03592.x 

Hosking JRM (2022). L-Moments. R package, version 2.9, https://CRAN.R-project.org/package=lmom.

Lilliefors, H.W., 1967. On the Kolmogorov-Smirnov test for normality with mean and variance unknown. Journal of the American Statistical Association, 62, 399-402. http://dx.doi.org/10.1080/01621459.1967.10482916

Mckee, T. B., Doesken, N. J. and Kleist, J., 1993. The relationship of drought frequency and duration to time scales. In: 8th Conference on Applied Climatology. Boston, MA: American Meteorological Society, 179–184.

Sparks A (2023). nasapower: NASA-POWER Data from R. doi:10.5281/zenodo.1040727, R package version 4.0.10, https://CRAN.R-project.org/package=nasapower.

Sparks A (2018). “nasapower: A NASA POWER Global Meteorology, Surface Solar Energy and Climatology Data Client for R.” The Journal of Open Source Software, 3(30), 1035. doi:10.21105/joss.01035.

Stagge, J. H., Tallaksen, L. M., Gudmundsson, L., Van Loon, A. F. and Stahl, K., 2015. Candidate distribution for climatological drought indices (SPI and SPEI). International Journal of Climatology, 35:13, 4027–4040. https://doi.org/10.1002/joc.4267.

Stagge, J. H., Tallaksen, L. M., Gudmundsson, L., Van Loon, A. F., Sthal K., 2016. Response to comment on ‘Candidate Distributions for Climatological Drought Indices (SPI and SPEI)’. International Journal of Climatology, 36:4, 2132-2136. https://doi.org/10.1002/joc.4564

Vicente-Serrano S. M. and Beguería S., 2016. Comment on ‘candidate distributions
for climatological drought indices (SPI and SPEI)’ by James
H. Stagge et al. International Journal of Climatology, 36:4, 2120–2131. https://doi.org/10.1002/joc.4474.

Vicente-Serrano, S. M., Beguería, S. and Lopez-Moreno, J. I., 2010. A multiscalar drought index sensitive to global warming: the standardized precipitation evapotranspiration index. Journal of Climate, 23, 1696–1718.  https://doi.org/10.1175/2009JCLI2909.1.

Willmott, C. J., Ackleson, S. G., Davis, R. E., Feddema, J. J., Klink, K. M., Legates, D. R., O’donnell, J. and Rowe, C. M., 1985. Statistics for the evaluation of model performance. Journal of Geophysical Research, 90, 8995-9005. https://dx.doi.org/10.1029/JC090iC05p08995

Wu, H., Svoboda, M. D., Hayes, M. J., Wilhite, D. A., Wen, F., 2007. Appropriate application of the standardized precipitation index in arid locations and dry seasons. International Journal of Climatology, 27:1, 65–79. https://doi.org/10.1002/joc.1371.
