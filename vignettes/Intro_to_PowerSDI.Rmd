---
title: "Introduction to PowerSDI"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to PowerSDI}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: bibliography.bib
---



# Introduction

{PowerSDI} calculates the Standardized Precipitation (SPI; @mckee1993) and Standardized Precipitation-Evapotranspiration (SPEI; @VicenteSerrano2010) indices using gridded-data from the NASA-POWER project.
The package includes functions (`ScientSDI()`, `Reference()`, `Accuracy()` and `PlotData()`), which evaluate how well the drought indices meet their conceptual assumptions.
The `OperatSDI()` function allows users to download NASA-POWER data for specific monitoring periods.
The package adopts a quasi-weekly basic time scale (`quart.month`), allowing for four index calculations per month: days 1 to 7, days 8 to 14, days 15 to 21, and days 22 to 28, 29, 30, or 31 depending on the month.
For instance, if the time scale is set to 4 (`TS = 4`), it corresponds to a moving window with a 1-month length that is calculated four times each month.
If `TS = 48`, the time scale corresponds to a moving window with a 12-month length that is calculated four times each month.
{PowerSDI} uses functions from the {nasapower} [@Sparks2018; @Sparks2023] and {Lmom} [@Hosking2023] packages.

# Basic Instructions: Getting Started

Load the library in your R session.


```r
library("PowerSDI")
```

## Using PlotData() to visually inspect NASA-POWER data

The `PlotData()` function allows a visual inspection of the indices' inputs (precipitation and potential evapotranspiration) obtained from the NASA-POWER project.
These inputs (in millimetres) are show at the 1-quart.month time scale.

## Example 1: Inspecting indices' input for Campinas-SP, Brazil


```r
PlotData(
  lon = -47.3,
  lat = -22.65,
  start.date = "1991-01-01",
  end.date = "2022-12-31"
)
#> Just a sec. Downloading NASA POWER data and calculating the others parameters.
```

<div class="figure" style="text-align: center">
<img src="PlotData-1.png" alt="plot of chunk PlotData"  />
<p class="caption">plot of chunk PlotData</p>
</div>

## ScientSDI(): Removing suspicious data and calculating the distributions's parameters

The first step of the SPI and SPEI algorithms is to calculate the cumulative probabilities of their input variables [@Guttman1999].
The `ScientSDI()` function estimates the parameters of the gamma, generalized extreme value (GEV), or generalized logistic distributions (GLO) through the L-moments method. This function also allows users to remove suspicious values from the data sample.

## Example 2: Applying the ScientSDI() function for Campinas-SP, Brazil

The plots generated by the `PlotData()` function for Campinas revealed one suspicious rain value larger than 250 mm.
Since this suspicious record represents less than 1% of the data sample, we removed it from the analyses before calculating the parameters of the gamma and GEV distributions.
The PE data showed no suspicious values.


```r
Campinas <- ScientSDI(
  lon = -47.3,
  lat = -22.65,
  start.date = "1991-01-01",
  end.date = "2022-12-31",
  distr = "GEV",
  TS = 4,
  Good = "no",
  RainUplim = 250,
  RainLowlim = NULL,
  PEUplim = NULL,
  PELowlim = NULL
)
#> Removed row(s) above limit: 420 for rain
#> The calculations started on: 1991-01-01
```

Check the SDI values.


```r
head(Campinas$SDI)
#>   Year Month quart.month   Rain  PE.Harg     PE.PM  PPE.Harg   PPE.PM        SPI
#> 1 1991     1           4 244.61 150.0216 130.63834  94.58841 113.9717 0.09109635
#> 2 1991     2           5 314.52 144.2429 122.63444 170.27707 191.8856 1.03838634
#> 3 1991     2           6 323.98 139.0874 119.42013 184.89255 204.5599 1.33262036
#> 4 1991     2           7 300.04 135.5081 117.25976 164.53189 182.7802 1.01676070
#> 5 1991     2           8 209.40 120.0983 103.70830  89.30168 105.6917 0.47371145
#> 6 1991     3           9 240.75 114.5312  98.32179 126.21877 142.4282 1.08669958
#>    SPEI.Harg    SPEI.PM Categ.SPI Categ.SPEI.Harg Categ.SPEI.PM
#> 1 -0.1547200 -0.1219909    Normal          Normal        Normal
#> 2  0.8686840  0.9317930   mod.wet          Normal        Normal
#> 3  1.3389665  1.4203094   mod.wet         mod.wet       mod.wet
#> 4  0.9373991  0.9709803   mod.wet          Normal        Normal
#> 5  0.4662448  0.5464568    Normal          Normal        Normal
#> 6  1.0617554  1.1428472   mod.wet         mod.wet       mod.wet
```

Check the DistPar


```r
head(Campinas$DistPar)
#>        lon    lat quart.month alfa.rain beta.rain probzero.rain loc.harg  sc.harg
#> [1,] -47.3 -22.65           1  7.408528  29.87982             0 34.27987 72.13735
#> [2,] -47.3 -22.65           2  8.764616  27.03333             0 54.57393 75.90788
#> [3,] -47.3 -22.65           3  9.446275  24.96878             0 55.28788 70.12587
#> [4,] -47.3 -22.65           4  9.797904  25.09108             0 78.42975 86.58305
#> [5,] -47.3 -22.65           5  7.515294  30.45793             0 67.38196 96.14252
#> [6,] -47.3 -22.65           6  8.519209  25.71193             0 57.03845 84.20085
#>         sh.harg   loc.pm     sc.pm      sh.pm TS
#> [1,] 0.03497598 50.53049  75.19133 0.04525515  4
#> [2,] 0.10441473 69.84435  80.30791 0.12659430  4
#> [3,] 0.05990299 68.60456  74.17211 0.05849914  4
#> [4,] 0.35852758 93.26131  94.57717 0.39586702  4
#> [5,] 0.50685016 81.63945 103.57943 0.57354133  4
#> [6,] 0.40529514 68.14458  88.69860 0.42914869  4
```

## Accuracy(): Verifying how well NASA-POWER data actually represent real-world/observed data

A basic assumption related to remote sensing data is that they really represent the "real-world" conditions.
Thus, the `Accuracy()` function calculates the following measures of accuracy: the absolute mean error (AME), root-mean-square-error (RMSE), original (dorig), modified (dmod), refined (dref) Willmott's indices of agreement, and Pearson determination coefficient (R2).

## Example 3: Applying the Accuracy function to compare observed (obs) and NASA-POWER PE data in Campinas-SP, Brazil

In the example below, `data("ObsEst")` contains pairs of observed and estimated potential evapotranspiration (PE) data.
The observed and estimated data were obtained from a weather station in Campinas and from the NASA-POWER project, respectively.
PE was estimated using the Hargreaves & Samani method [@Hargreaves1985].


```r
data("ObsEst")

Compare_PE_Cps <- Accuracy(obs_est = ObsEst, conf.int = "No")

Compare_PE_Cps
#>       AME     RMSE     dorig      dmod     dref     RQuad
#>  2.470223 3.144231 0.9718557 0.8386579 0.838266 0.9590222
```

## OperatSDI(): Generating routine operational NASA-SPI and NASA-SPEI estimates

Considering that the parameters of the gamma (SPI) and GEV (SPEI) distributions have already been estimated by the `ScientSDI()` function, we can now use the `OperatSDI()` function to calculate these two indices on a routine basis.

## Example 4: Applying the OperatSDI function to calculate the SPI and SPEI in Campinas-SP, Brazil

The OperatSDI function enables users to download NASA-POWER data only for the period they intend to monitor.


```r
parms <- Campinas$DistPar # Obtained in Example 2
SDI <- OperatSDI(
  lon = -47.3,
  lat = -22.65,
  start.date = "2023-08-01",
  end.date = "2023-08-07",
  parms = Campinas$DistPar,
  TS = 4
)
#> Calculating...
#> Considering the selected `TS`, the calculations started on: 2023-06-22

SDI
#>     Lon    Lat Year Month quart.month  Rain       PE       PPE         SPI       SPEI
#> 1 -47.3 -22.65 2023     7          27 15.85 69.26648 -53.41648 -0.16717343 -0.3763845
#> 2 -47.3 -22.65 2023     7          28 16.63 75.31934 -58.68934 -0.09507928 -0.2451151
#> 3 -47.3 -22.65 2023     8          29 16.50 81.19896 -64.69896 -0.23425126 -0.5276402
#>   Categ.SPI Categ.SPEI
#> 1    Normal     Normal
#> 2    Normal     Normal
#> 3    Normal     Normal
```

# Not So Basic Instructions:

## The ScientSDI() function: Removing suspicious data and assessing the indices' conceptual assumptions

Standardized indices, both SPI and SPEI are expected to provide spatially consistent interpretations of their values [@Guttman1999].
Therefore, their frequency distributions are expected to always approach the standard normal distribution regardless of the region, season, or time scale at which the indices are calculated [@Wu2006; @Stagge2015; @Blain2017].
In this context, the ScientSDI function calculates two normality-checking procedures described by @Wu2006 and @Stagge2015.
Additionally, the calculation algorithm of the SPI and SPEI relies on fitting a parametric distribution to their input data.
Therefore, the `ScientSDI()` function also applies the widely-used Lilliefors [@Lilliefors1967] and Anderson-Darling [@Anderson1954] goodness-of-fit tests to the gamma and GEV/GLO distributions.
The function `ScientSDI()` allows users to select significance levels ranging from 5 to 10% to run these tests.
Additionally, the SPEI algorithm often uses the generalized extreme value (GEV) or the generalized logistic (GLO) [@VicenteSerrano2010; Begueria2013; @Stagge2015; @Stagge2015a; @VicenteSerrano2015; @Blain2017].
A review of these studies suggests that the performance of these two distributions for calculating the SPEI tends to be similar to each other over most of the range of the index possible values (e.g. -2.0:2:0).
However, these studies also found significant differences between the two probability functions in the lower and upper tails [@VicenteSerrano2015].
In this context, the `ScientSDI()` function also allows the users to choose between these two models when calculating the SPEI.

## Example 5.1: Applying the ScientSDI() function with the GEV and verifying conceptual assumptions (Campinas-SP).


```r
Campinas.GEV <- ScientSDI(
  lon = -47.3,
  lat = -22.65,
  start.date = "1991-01-01",
  end.date = "2022-12-31",
  distr = "GEV",
  TS = 4,
  Good = "yes",
  sig.level = 0.95,
  RainUplim = 250,
  RainLowlim = NULL,
  PEUplim = NULL,
  PELowlim = NULL
)
#> Removed row(s) above limit: 420 for rain
#> The calculations started on: 1991-01-01
```

Check the goodness of fit.


```r
head(Campinas.GEV$GoodFit)
#>       Lili.Rain      Crit Lili.PPEHarg      Crit Lili.PPEPM      Crit   AD.Rain
#> [1,] 0.11611448 0.1421074   0.09598566 0.1247574 0.10968643 0.1208956 0.6390502
#> [2,] 0.11600471 0.1375066   0.09478670 0.1239462 0.08197176 0.1272034 0.9182668
#> [3,] 0.13690470 0.1387885   0.14118126 0.1236251 0.13697722 0.1246724 0.8535305
#> [4,] 0.12338364 0.1379305   0.12686151 0.1225838 0.12165418 0.1201919 0.7133716
#> [5,] 0.05656565 0.1391922   0.05754187 0.1210613 0.05063817 0.1217631 0.1413624
#> [6,] 0.07813975 0.1427933   0.08560787 0.1201099 0.10364726 0.1237171 0.6182675
#>           Crit AD.PPEHarg      Crit  AD.PPEPM      Crit
#> [1,] 0.7238831  0.3616846 0.5656790 0.3730867 0.5346740
#> [2,] 0.6977371  0.3126301 0.5620308 0.2904369 0.6221887
#> [3,] 0.7290795  0.5919410 0.5353827 0.6846267 0.5567322
#> [4,] 0.6821497  0.6254738 0.5076662 0.6207135 0.5128184
#> [5,] 0.7281685  0.1390590 0.5164560 0.1181277 0.5175488
#> [6,] 0.7549473  0.2836658 0.4990351 0.3300447 0.5330804
```

Check the normality.


```r
head(Campinas.GEV$Normality)
#>      SPI.Shap            SPI.Shap.p           SPI.AbsMed          
#> [1,] "0.967900296734503" "0.463209059642815"  "0.0997964641569041"
#> [2,] "0.96619340372341"  "0.420858893940406"  "0.0104781137427224"
#> [3,] "0.975582768775712" "0.682405906920205"  "0.129821941048217" 
#> [4,] "0.953414578207946" "0.180061525951205"  "0.168690442662682" 
#> [5,] "0.930008418348121" "0.0391836955173206" "0.291796230478462" 
#> [6,] "0.940736018465501" "0.0785562689884901" "0.198234408496805" 
#>      SPEI.Harg.Shap      SPEI.Harg.Shap.p    SPEI.Harg.AbsMed     SPEI.PM.Shap       
#> [1,] "0.969861827113516" "0.515272137676815" "0.186815392316225"  "0.970695818058461"
#> [2,] "0.967534923633657" "0.453904486982245" "0.0168911320780577" "0.975467516410612"
#> [3,] "0.97709792103516"  "0.728130025102689" "0.1537227612179"    "0.984337613901716"
#> [4,] "0.977125125892329" "0.712741560432411" "0.0117205563442516" "0.97434881364782" 
#> [5,] "0.965498377717103" "0.38523862322998"  "0.113850675858054"  "0.967452436359796"
#> [6,] "0.949172196570768" "0.136525158267929" "0.0795960163121175" "0.944866764786556"
#>      SPEI.PM.Shap.p      SPEI.PM.AbsMed       SPI.testI  SPEI.Harg.testI
#> [1,] "0.538411985296207" "0.131238556799408"  "Normal"   "Normal"       
#> [2,] "0.678919851955902" "0.0862958970568239" "Normal"   "Normal"       
#> [3,] "0.918405405139991" "0.125621342952482"  "Normal"   "Normal"       
#> [4,] "0.626881830625539" "0.0317805463249865" "Normal"   "Normal"       
#> [5,] "0.432224826086055" "0.115631760508116"  "NoNormal" "Normal"       
#> [6,] "0.102960431525811" "0.118262535289091"  "NoNormal" "Normal"       
#>      SPEI.PM.testI SPI.testII SPEI.Harg.testII SPEI.PM.testII
#> [1,] "Normal"      "Normal"   "Normal"         "Normal"      
#> [2,] "Normal"      "Normal"   "Normal"         "Normal"      
#> [3,] "Normal"      "Normal"   "Normal"         "Normal"      
#> [4,] "Normal"      "Normal"   "Normal"         "Normal"      
#> [5,] "Normal"      "NoNormal" "Normal"         "Normal"      
#> [6,] "Normal"      "Normal"   "Normal"         "Normal"
```

## Example 5.2: Applying the ScientSDI() function with the GLO and verifying conceptual assumptions (Campinas-SP).


```r
Campinas.GLO <- ScientSDI(
  lon = -47.3,
  lat = -22.65,
  start.date = "1991-01-01",
  end.date = "2022-12-31",
  distr = "GLO",
  TS = 4,
  Good = "yes",
  sig.level = 0.95,
  RainUplim = 250,
  RainLowlim = NULL,
  PEUplim = NULL,
  PELowlim = NULL
)
#> Removed row(s) above limit: 420 for rain
#> The calculations started on: 1991-01-01
```

Check the goodness of fit.


```r
head(Campinas.GLO$GoodFit)
#>       Lili.Rain      Crit Lili.PPEHarg      Crit Lili.PPEPM      Crit   AD.Rain
#> [1,] 0.11611448 0.1396679   0.07616393 0.1265476 0.08737459 0.1250066 0.6390502
#> [2,] 0.11600471 0.1398178   0.07720066 0.1309613 0.08068476 0.1297558 0.9182668
#> [3,] 0.13690470 0.1423751   0.11506476 0.1222395 0.10845248 0.1260868 0.8535305
#> [4,] 0.12338364 0.1384149   0.10910058 0.1237105 0.10436888 0.1251850 0.7133716
#> [5,] 0.05656565 0.1398221   0.04729337 0.1251448 0.04834128 0.1271363 0.1413624
#> [6,] 0.07813975 0.1382788   0.10927108 0.1268700 0.12667715 0.1282937 0.6182675
#>           Crit AD.PPEHarg      Crit  AD.PPEPM      Crit
#> [1,] 0.6946110  0.2341804 0.5392694 0.2318249 0.5340606
#> [2,] 0.7378976  0.2985981 0.5800732 0.2827102 0.5849745
#> [3,] 0.7205251  0.4351606 0.5295015 0.5205419 0.5615967
#> [4,] 0.7382438  0.5883399 0.5284099 0.5872241 0.5342930
#> [5,] 0.7114699  0.1100622 0.5593671 0.1053168 0.5711214
#> [6,] 0.7408576  0.4527839 0.5388321 0.5257735 0.5554602
```

Check the normality.


```r
head(Campinas.GLO$GoodFit)
#>       Lili.Rain      Crit Lili.PPEHarg      Crit Lili.PPEPM      Crit   AD.Rain
#> [1,] 0.11611448 0.1396679   0.07616393 0.1265476 0.08737459 0.1250066 0.6390502
#> [2,] 0.11600471 0.1398178   0.07720066 0.1309613 0.08068476 0.1297558 0.9182668
#> [3,] 0.13690470 0.1423751   0.11506476 0.1222395 0.10845248 0.1260868 0.8535305
#> [4,] 0.12338364 0.1384149   0.10910058 0.1237105 0.10436888 0.1251850 0.7133716
#> [5,] 0.05656565 0.1398221   0.04729337 0.1251448 0.04834128 0.1271363 0.1413624
#> [6,] 0.07813975 0.1382788   0.10927108 0.1268700 0.12667715 0.1282937 0.6182675
#>           Crit AD.PPEHarg      Crit  AD.PPEPM      Crit
#> [1,] 0.6946110  0.2341804 0.5392694 0.2318249 0.5340606
#> [2,] 0.7378976  0.2985981 0.5800732 0.2827102 0.5849745
#> [3,] 0.7205251  0.4351606 0.5295015 0.5205419 0.5615967
#> [4,] 0.7382438  0.5883399 0.5284099 0.5872241 0.5342930
#> [5,] 0.7114699  0.1100622 0.5593671 0.1053168 0.5711214
#> [6,] 0.7408576  0.4527839 0.5388321 0.5257735 0.5554602
```

## The Accuracy() function: Applying the Accuracy function and calculating confidence intervals.

The `Accuracy()` function may also provide confidence intervals (CI) for AME, RMSE, dorig, dmod and dref.
As emphasized by @Willmott1985, the CI specifies a range of values within which these statistics are expected to vary by chance.
Consequently, users can interpret the magnitude of the CI as an indicator of the reliability of the estimated values for the comparison metrics @Willmott1985.
The function allows users to select between 90 and 95% CIs.

## Example 6: Applying the Accuracy function and calculating confidence intervals (Campinas-SP).


```r
data("ObsEst")
Compare_PE_Cps_withCI <-
  Accuracy(obs_est = ObsEst,
           conf.int = "yes",
           sig.level = 0.95)
#> Just a sec
Compare_PE_Cps_withCI
#>  AMECIinf      AME AMECIsup RMSECIinf     RMSE RMSECIsup dorig_CIinf     dorig
#>  2.466806 2.470223 2.473361  3.139026 3.144231  3.147118   0.9717802 0.9718557
#>  dorigCIsup dmodCIinf      dmod dmodCIsup dref_CIinf     dref dref_CIsup RQuad_CIinf
#>   0.9719585 0.8383612 0.8386579 0.8389019  0.8379464 0.838266  0.8384804   0.9589449
#>      RQuad RQuad_CIsup
#>  0.9590222   0.9592174
```

# References
